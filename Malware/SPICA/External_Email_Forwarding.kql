//Detection for all extrenal email forwarding/transport rules. Uses MailboxOwnerUPN field to remove internal to internal forwarding rules. 
let Domains =
OfficeActivity
| where isnotempty(MailboxOwnerUPN)
| extend OwnDomains = tostring(split(MailboxOwnerUPN, "@")[1])
| distinct OwnDomains;
OfficeActivity
| where TimeGenerated >= ago(30d)
| where OfficeWorkload contains "Exchange" and Operation contains "Set-Mailbox" 
and Parameters contains "DeliverToMailboxAndForward"
| extend ForwardedEmailAddress = tostring(parse_json(Parameters)[1].Value)
| where not(ForwardedEmailAddress has_any (Domains))
| where isnotempty(ForwardedEmailAddress)
| project TimeGenerated, ForwardedEmailAddress, OfficeObjectId, UserId 
